class ModalManager{constructor(){this.scrollbarWidth=0;this.originalBodyStyles={overflow:'',paddingRight:'',position:''};this.isModalOpen=false;this.activeModals=new Set();this.calculateScrollbarWidth();this.openModal=this.openModal.bind(this);this.closeModal=this.closeModal.bind(this);this.closeAllModals=this.closeAllModals.bind(this);}
calculateScrollbarWidth(){const scrollbarWidth1=window.innerWidth-document.documentElement.clientWidth;const outer=document.createElement('div');outer.style.cssText=`position:absolute;top:-9999px;width:100px;height:100px;overflow:scroll;visibility:hidden;`;document.body.appendChild(outer);const scrollbarWidth2=outer.offsetWidth-outer.clientWidth;document.body.removeChild(outer);this.scrollbarWidth=scrollbarWidth2||scrollbarWidth1||17;document.documentElement.style.setProperty('--scrollbar-width',`${this.scrollbarWidth}px`);console.log(`[ModalManager]Detected scrollbar width:${this.scrollbarWidth}px`);return this.scrollbarWidth;}
storeOriginalBodyStyles(){const computedStyle=window.getComputedStyle(document.body);this.originalBodyStyles={overflow:document.body.style.overflow||computedStyle.overflow,paddingRight:document.body.style.paddingRight||computedStyle.paddingRight,position:document.body.style.position||computedStyle.position};}
applyBodyLock(){if(this.activeModals.size===0){this.storeOriginalBodyStyles();}
const body=document.body;body.style.overflow='hidden';const currentPaddingRight=parseInt(this.originalBodyStyles.paddingRight)||0;body.style.paddingRight=`${currentPaddingRight+this.scrollbarWidth}px`;body.classList.add('modal-open');console.log(`[ModalManager]Body lock applied.Padding:${currentPaddingRight+this.scrollbarWidth}px`);}
removeBodyLock(){const body=document.body;body.style.overflow=this.originalBodyStyles.overflow;body.style.paddingRight=this.originalBodyStyles.paddingRight;body.classList.remove('modal-open');console.log('[ModalManager] Body lock removed, original styles restored');}
openModal(modalId,modalElement=null){if(this.activeModals.has(modalId)){console.warn(`[ModalManager]Modal ${modalId}is already open`);return;}
this.activeModals.add(modalId);if(this.activeModals.size===1){this.applyBodyLock();}
if(modalElement){modalElement.style.display='flex';modalElement.classList.remove('hidden');modalElement.setAttribute('aria-modal','true');modalElement.setAttribute('role','dialog');}
this.isModalOpen=true;console.log(`[ModalManager]Modal ${modalId}opened.Active modals:${this.activeModals.size}`);window.dispatchEvent(new CustomEvent('modalOpened',{detail:{modalId,activeCount:this.activeModals.size}}));}
closeModal(modalId,modalElement=null){if(!this.activeModals.has(modalId)){console.warn(`[ModalManager]Modal ${modalId}is not open`);return;}
this.activeModals.delete(modalId);if(modalElement){modalElement.style.display='none';modalElement.classList.add('hidden');modalElement.removeAttribute('aria-modal');modalElement.removeAttribute('role');}
if(this.activeModals.size===0){this.removeBodyLock();this.isModalOpen=false;}
console.log(`[ModalManager]Modal ${modalId}closed.Active modals:${this.activeModals.size}`);window.dispatchEvent(new CustomEvent('modalClosed',{detail:{modalId,activeCount:this.activeModals.size}}));}
closeAllModals(){const modalIds=Array.from(this.activeModals);modalIds.forEach(modalId=>{this.closeModal(modalId);});this.activeModals.clear();this.removeBodyLock();this.isModalOpen=false;console.log('[ModalManager] All modals force-closed');}
getState(){return{isModalOpen:this.isModalOpen,activeModals:Array.from(this.activeModals),scrollbarWidth:this.scrollbarWidth};}
recalculateScrollbarWidth(){const wasOpen=this.isModalOpen;const activeModalIds=Array.from(this.activeModals);if(wasOpen){this.closeAllModals();}
this.calculateScrollbarWidth();if(wasOpen&&activeModalIds.length>0){activeModalIds.forEach(modalId=>{this.openModal(modalId);});}}}
const modalManager=new ModalManager();window.ModalUtils={open:modalManager.openModal,close:modalManager.closeModal,closeAll:modalManager.closeAllModals,getState:modalManager.getState,recalculate:modalManager.recalculateScrollbarWidth};let resizeTimeout;window.addEventListener('resize',()=>{clearTimeout(resizeTimeout);resizeTimeout=setTimeout(()=>{modalManager.recalculateScrollbarWidth();},250);});document.addEventListener('keydown',(event)=>{if(event.key==='Escape'&&modalManager.isModalOpen){modalManager.closeAllModals();}});if(typeof module!=='undefined'&&module.exports){module.exports={ModalManager,modalManager};}
console.log('[ModalManager] Initialized successfully');document.addEventListener('DOMContentLoaded',function(){const chatForm=document.getElementById('chat-form');const chatContainer=document.getElementById('chat-container');const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');if(chatForm){chatForm.addEventListener('submit',async function(e){e.preventDefault();const userInput=document.getElementById('chat-input').value;if(!userInput)return;appendMessage(userInput,'user-message');document.getElementById('chat-input').value='';try{const response=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify({prompt:userInput})});if(!response.ok){throw new Error(`HTTP error!status:${response.status}`);}
const data=await response.json();appendMessage(data.response,'ai-message');}catch(error){console.error('Error fetching AI response:',error);appendMessage('Sorry, something went wrong. Please try again.','ai-message error');}});}
function appendMessage(text,className){const messageElement=document.createElement('div');messageElement.className=`chat-message ${className}`;messageElement.textContent=text;chatContainer.appendChild(messageElement);chatContainer.scrollTop=chatContainer.scrollHeight;}});