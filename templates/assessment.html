{% extends "base.html" %}

{% block title %}Mental Health Assessment - Mindful Horizon{% endblock %}
{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<!-- Assessment data will be passed via data attribute -->
<div id="assessment-data" data-assessments='{{ assessments|tojson|safe if assessments else "[]" }}'></div>

<script type="text/javascript">
    // Get assessment data from data attribute
    const assessmentData = JSON.parse(document.getElementById('assessment-data').dataset.assessments || '[]');
</script>

<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Mental Health Assessment</h1>
        <p class="text-gray-600">Complete this assessment to track your mental well-being and get personalized insights</p>
    </div>

    <!-- Assessment Selection -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="card cursor-pointer hover:shadow-xl transition-all duration-300 start-assessment-btn" data-assessment-type="GAD-7">
            <div class="text-center">
                <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-heartbeat text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Anxiety Screening (GAD-7)</h3>
                <p class="text-gray-600 text-sm mb-4">7-question assessment for anxiety symptoms</p>
                <div class="bg-blue-50 p-3 rounded-lg">
                    <span class="text-sm text-blue-700">⏱️ Takes 2-3 minutes</span>
                </div>
                <button class="mt-3 btn-primary w-full" aria-label="Start Anxiety Assessment">Start Assessment</button>
            </div>
        </div>

        <div class="card cursor-pointer hover:shadow-xl transition-all duration-300 start-assessment-btn" data-assessment-type="PHQ-9">
            <div class="text-center">
                <div class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-brain text-purple-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Depression Screening (PHQ-9)</h3>
                <p class="text-gray-600 text-sm mb-4">9-question assessment for depression symptoms</p>
                <div class="bg-purple-50 p-3 rounded-lg">
                    <span class="text-sm text-purple-700">⏱️ Takes 5-7 minutes</span>
                </div>
                <button class="mt-3 btn-primary w-full" aria-label="Start Depression Assessment">Start Assessment</button>
            </div>
        </div>
    </div>

    <!-- Daily Mood Check -->
    <div class="card mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-smile text-yellow-500 mr-2"></i>Daily Mood Check
        </h3>
        <p class="text-gray-600 mb-4">How are you feeling today? This helps track your mood patterns over time.</p>
        
        <div class="grid grid-cols-5 gap-4 mb-4">
            <div class="text-center cursor-pointer mood-option" data-mood="1" onclick="selectMood(1)">
                <div class="text-4xl mb-2">😢</div>
                <span class="text-sm text-gray-600">Very Low</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="2" onclick="selectMood(2)">
                <div class="text-4xl mb-2">😟</div>
                <span class="text-sm text-gray-600">Low</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="3" onclick="selectMood(3)">
                <div class="text-4xl mb-2">😐</div>
                <span class="text-sm text-gray-600">Neutral</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="4" onclick="selectMood(4)">
                <div class="text-4xl mb-2">🙂</div>
                <span class="text-sm text-gray-600">Good</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="5" onclick="selectMood(5)">
                <div class="text-4xl mb-2">😊</div>
                <span class="text-sm text-gray-600">Excellent</span>
            </div>
        </div>
        
        <div class="flex flex-col items-center">
            <div id="mood-notes-container" class="w-full mb-4 hidden">
                <label for="mood-notes" class="block text-sm font-medium text-gray-700 mb-1">Add a note (optional):</label>
                <textarea id="mood-notes" class="w-full p-2 border rounded-lg" rows="2" placeholder="How are you feeling today?"></textarea>
            </div>
            <button id="save-mood-btn" class="btn-primary" onclick="saveDailyMood()" disabled aria-label="Save your daily mood assessment">
                <i class="fas fa-save mr-2"></i>Save Today's Mood
            </button>
        </div>
    </div>

    <!-- Assessment History Chart -->
    <div class="card mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-line text-green-500 mr-2"></i>Assessment Score Trends
        </h3>
        <div class="assessment-chart-container">
            <canvas id="assessment-history-chart"></canvas>
        </div>
        <div class="text-sm text-gray-600 mt-2">
            <i class="fas fa-info-circle mr-2"></i>
            Track your mental health scores over time to see your progress.
        </div>
    </div>

    <!-- Assessment History Table -->
    <div class="card">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-history text-blue-500 mr-2"></i>Assessment History
        </h3>
        
        <div class="overflow-x-auto">
            <table class="w-full table-auto">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Assessment Type</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Score</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Severity</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody id="assessmentHistory">
                    {% if assessments %}
                        {% for assessment in assessments %}
                        <tr>
                            <td class="px-4 py-3 text-sm text-gray-700">{{ assessment.created_at }}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">{{ assessment.assessment_type }}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-blue-600">{{ assessment.score }}</td>
                            <td class="px-4 py-3 text-sm">
                                {% set severity_info = get_severity_info(assessment.assessment_type, assessment.score) %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-{{ severity_info.color }}-100 text-{{ severity_info.color }}-800">{{ severity_info.severity }}</span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="viewAssessmentDetails('{{ assessment.id }}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-4 py-3 text-sm text-gray-600 text-center">No assessments recorded yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- AI Insights Section -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-robot text-blue-500 mr-2"></i> AI-Powered Insights
            </h4>

            <!-- Loading State (hidden by default; shown when generating insights) -->
            <div id="aiInsightsLoading" class="hidden text-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                <p class="text-gray-600">Analyzing your responses...</p>
            </div>

<!-- AI Insights Content -->
<div id="aiInsightsContent" class="space-y-4 {% if not latest_insights %}hidden{% endif %}">
    <div class="bg-white p-4 rounded-lg border border-gray-200">
        <h5 class="font-medium text-gray-800 mb-2 flex items-center">
            <i class="fas fa-comment-alt text-blue-500 mr-2"></i> Summary
        </h5>
        <p id="aiSummary" class="text-gray-700">
            {% if latest_insights and latest_insights.summary %}
                {{ latest_insights.summary }}
            {% else %}
                No summary available.
            {% endif %}
        </p>
    </div>

    <div class="bg-white p-4 rounded-lg border border-gray-200">
        <h5 class="font-medium text-gray-800 mb-2 flex items-center">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i> Recommendations
        </h5>
        <ul id="aiRecommendations" class="space-y-2">
            {% if latest_insights and latest_insights.recommendations %}
                {% for rec in latest_insights.recommendations %}
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                        <span>{{ rec }}</span>
                    </li>
                {% endfor %}
            {% else %}
                <li class="flex items-start">
                    <div class="animate-pulse bg-gray-200 h-4 w-3/4 rounded"></div>
                </li>
            {% endif %}
        </ul>
    </div>

    <div class="bg-white p-4 rounded-lg border border-gray-200">
        <h5 class="font-medium text-gray-800 mb-2 flex items-center">
            <i class="fas fa-book-open text-green-500 mr-2"></i> Resources
        </h5>
        <ul id="aiResources" class="space-y-2">
            {% if latest_insights and latest_insights.resources %}
                {% for res in latest_insights.resources %}
                    <li class="flex items-start">
                        <i class="fas fa-external-link-alt text-blue-500 mt-1 mr-2"></i>
                        <span>{{ res }}</span>
                    </li>
                {% endfor %}
            {% else %}
                <li class="flex items-start">
                    <div class="animate-pulse bg-gray-200 h-4 w-1/2 rounded"></div>
                </li>
            {% endif %}
        </ul>
    </div>
</div>

<!-- Assessment Modal - Fixed positioning and visibility -->
<div id="assessmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="assessmentTitle" class="text-xl font-semibold text-gray-800">Assessment</h3>
            <button onclick="closeAssessment()" class="text-gray-500 hover:text-gray-700" aria-label="Close Assessment">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="assessment-loading" class="text-center py-8 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading questions...</p>
        </div>

        <div id="assessment-error" class="text-center py-8 hidden">
            <div class="text-6xl text-red-500 mb-4">✗</div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Something went wrong</h2>
            <p class="text-gray-600 mb-6">Could not load assessment questions. Please try again later.</p>
            <button onclick="closeAssessment()" class="btn-primary">Close</button>
        </div>

        <div id="assessment-question-container" class="hidden">
            <div id="assessment-progress" class="text-sm text-gray-600 mb-4 text-center"></div>
            <h4 id="assessment-question" class="text-lg font-medium text-gray-800 mb-4"></h4>
            <div id="assessment-options" class="space-y-3"></div>
        </div>

                <div class="flex justify-between mt-6">
            <!-- Removed Next and Complete Assessment buttons as requested -->
        </div>
    </div>
</div>
</div>

<script>
const csrfToken = '{{ csrf_token() }}';
let currentAssessment = null;
let currentQuestion = 0;
let assessmentAnswers = [];
let selectedMood = null;
let assessmentChart = null;
let assessmentHistoryChart = null; // Keep track of the chart instance
let chartUpdateTimeout = null; // Debounce chart updates
let isChartInitialized = false; // Prevent multiple initializations

// Assessment Modal Management using centralized ModalUtils
const ASSESSMENT_MODAL_ID = 'assessment-modal';

// Wait for ModalUtils to be available
function waitForModalUtils(callback) {
    if (typeof window.ModalUtils !== 'undefined') {
        callback();
    } else {
        setTimeout(() => waitForModalUtils(callback), 50);
    }
}

// Assessment data
const assessments = {
    anxiety: {
        title: "GAD-7 Anxiety Assessment",
        type: "GAD-7",
        description: "Over the last 2 weeks, how often have you been bothered by the following problems?",
        questions: [
            "Feeling nervous, anxious, or on edge",
            "Not being able to stop or control worrying",
            "Worrying too much about different things",
            "Trouble relaxing",
            "Being so restless that it's hard to sit still",
            "Becoming easily annoyed or irritable",
            "Feeling afraid as if something awful might happen"
        ],
        options: [
            { value: 0, text: "Not at all" },
            { value: 1, text: "Several days" },
            { value: 2, text: "More than half the days" },
            { value: 3, text: "Nearly every day" }
        ]
    },
    depression: {
        title: "PHQ-9 Depression Screening",
        type: "PHQ-9",
        description: "Over the last 2 weeks, how often have you been bothered by any of the following problems?",
        questions: [
            "Little interest or pleasure in doing things",
            "Feeling down, depressed, or hopeless",
            "Trouble falling or staying asleep, or sleeping too much",
            "Feeling tired or having little energy",
            "Poor appetite or overeating",
            "Feeling bad about yourself or that you are a failure or have let yourself or your family down",
            "Trouble concentrating on things, such as reading the newspaper or watching television",
            "Moving or speaking so slowly that other people could have noticed, or the opposite being so fidgety or restless that you have been moving around a lot more than usual",
            "Thoughts that you would be better off dead, or of hurting yourself"
        ],
        options: [
            { value: 0, text: "Not at all" },
            { value: 1, text: "Several days" },
            { value: 2, text: "More than half the days" },
            { value: 3, text: "Nearly every day" }
        ]
    }
};

function startAssessment(type) {
    // Prevent multiple modal instances
    if (currentAssessment !== null) {
        return;
    }
    
    currentAssessment = assessments[type];
    currentQuestion = 0;
    assessmentAnswers = [];
    
    const modal = document.getElementById('assessmentModal');
    const title = document.getElementById('assessmentTitle');
    
    if (title && currentAssessment) {
        title.textContent = currentAssessment.title;
    }
    
    if (modal) {
        // Use centralized ModalUtils for layout shift prevention
        waitForModalUtils(() => {
            window.ModalUtils.open(ASSESSMENT_MODAL_ID, modal);
        });
    }
    
    showQuestion();
}

function showQuestion() {
    const content = document.getElementById('assessmentContent');
    const question = currentAssessment.questions[currentQuestion];
    
    let html = `
        <div class="mb-4">
            <p class="text-gray-600 text-sm mb-4">${currentAssessment.description}</p>
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <span class="text-sm text-blue-600">Question ${currentQuestion + 1} of ${currentAssessment.questions.length}</span>
                <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${((currentQuestion + 1) / currentAssessment.questions.length) * 100}%"></div>
                </div>
            </div>
        </div>
        
        <h4 class="text-lg font-medium text-gray-800 mb-4">${question}</h4>
        
        <div class="space-y-3">
    `;
    
    currentAssessment.options.forEach((option, index) => {
        const isSelected = assessmentAnswers[currentQuestion] === option.value;
        html += `
            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}">
                <input type="radio" name="answer" value="${option.value}" class="mr-3" ${isSelected ? 'checked' : ''} onchange="selectAnswer(${option.value})" aria-label="${option.text}">
                <span class="text-gray-700">${option.text}</span>
            </label>
        `;
    });
    
    html += '</div>';
    content.innerHTML = html;
    
    // Update navigation buttons
    document.getElementById('prevBtn').disabled = currentQuestion === 0;
    const nextBtn = document.getElementById('nextBtn');
    
    if (currentQuestion === currentAssessment.questions.length - 1) {
        nextBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Assessment';
        nextBtn.onclick = completeAssessment;
        console.log("DEBUG: 'Complete Assessment' button handler assigned.");
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right ml-2"></i>';
        nextBtn.onclick = nextQuestion;
        console.log("DEBUG: 'Next' button handler assigned.");
    }
}

function selectAnswer(value) {
    assessmentAnswers[currentQuestion] = value;
}

function nextQuestion() {
    if (assessmentAnswers[currentQuestion] === undefined) {
        alert('Please select an answer before continuing.');
        return;
    }
    
    if (currentQuestion < currentAssessment.questions.length - 1) {
        currentQuestion++;
        showQuestion();
    }
}

function previousQuestion() {
    if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion();
    }
}

async function completeAssessment() {
    console.log("DEBUG: completeAssessment function called.");
    // Ensure an answer is selected for the current question
    if (assessmentAnswers[currentQuestion] === undefined) {
        showNotification('Please select an answer before completing the assessment.', 'error');
        return;
    }

    // Calculate total score
    const totalScore = assessmentAnswers.reduce((sum, score) => sum + (score || 0), 0);
    const maxScore = currentAssessment.questions.length * 3;
    const questionContainer = document.getElementById('assessmentContent'); // Target the main content area of the modal
    const nextBtn = document.getElementById('nextBtn');
    const modal = document.getElementById('assessmentModal');
    
    // Disable the complete button to prevent multiple submissions
    if (nextBtn) nextBtn.disabled = true;

    // Show loading state
    questionContainer.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Processing your assessment...</p>
        </div>
    `;

    try {
        // Save assessment to backend
        const response = await fetch('/api/save-assessment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                assessment_type: currentAssessment.type,
                score: totalScore,
                responses: assessmentAnswers
            })
        });

        if (!response.ok) {
            throw new Error('Failed to save assessment. Please try again.');
        }

        const data = await response.json();
        
        // If there's an error in the response
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (response.ok) {
            // Update points display if it exists
            if (data.points_earned) {
                const pointsElement = document.getElementById('user-points');
                if (pointsElement) {
                    const currentPoints = parseInt(pointsElement.textContent) || 0;
                    pointsElement.textContent = currentPoints + data.points_earned;
                }
            }
            
            // Show success notification
            showNotification('Assessment submitted successfully!', 'success');
            
            // Close the modal immediately
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Handle AI insights display based on the flag
            const aiInsightsSection = document.getElementById('aiInsightsContent');
            const aiLoadingSection = document.getElementById('aiInsightsLoading');
            const aiComingSoonSection = document.getElementById('aiInsightsComingSoon');

            if (data.ai_insights_generated === false) {
                // If AI insights were not generated successfully, show a message
                if (aiComingSoonSection) {
                    aiComingSoonSection.classList.remove('hidden');
                    aiComingSoonSection.innerHTML = '<p class="text-sm text-gray-600">AI insights are currently unavailable. Please try again later.</p>';
                }
                if (aiLoadingSection) aiLoadingSection.classList.add('hidden');
                if (aiInsightsSection) aiInsightsSection.classList.add('hidden'); // Hide actual insights if they were somehow shown
            } else {
                // If AI insights were generated, display them
                const insights = data.ai_insights;
                const summaryEl = document.getElementById('aiSummary');
                const recommendationsEl = document.getElementById('aiRecommendations');
                const resourcesEl = document.getElementById('aiResources');

                if (summaryEl) {
                    summaryEl.textContent = insights.summary || 'No summary available.';
                }

                if (recommendationsEl && insights.recommendations) {
                    recommendationsEl.innerHTML = insights.recommendations
                        .map(rec => '<li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i><span>' + rec + '</span></li>')
                        .join('');
                }

                if (resourcesEl && insights.resources) {
                    resourcesEl.innerHTML = insights.resources
                        .map(res => '<li class="flex items-start"><i class="fas fa-external-link-alt text-blue-500 mt-1 mr-2"></i><span>' + res + '</span></li>')
                        .join('');
                }

                // Show the AI insights section
                if (aiInsightsSection) aiInsightsSection.classList.remove('hidden');
                if (aiLoadingSection) aiLoadingSection.classList.add('hidden');
                if (aiComingSoonSection) aiComingSoonSection.classList.add('hidden'); // Hide coming soon if it was shown

                // Hide the 'no insights' message
                const noInsightsMessage = document.getElementById('noInsightsMessage');
                if (noInsightsMessage) {
                    noInsightsMessage.classList.add('hidden');
                }
            }
            
            // Update the history table and chart
            const newAssessment = {
                id: data.assessment_id,
                assessment_type: currentAssessment.type,
                score: totalScore,
                created_at: new Date().toISOString(),
                ai_insights: data.ai_insights
            };
            updateAssessmentHistory(newAssessment);

            // No longer reloading the page to keep the insights visible
            // setTimeout(() => {
            //     location.reload();
            // }, 500);
            
        } else {
            throw new Error(data.message || 'Failed to save assessment');
        }
        
    } catch (error) {
        console.error('Error saving assessment:', error);
        questionContainer.innerHTML = `
            <div class="text-center py-6">
                <div class="text-6xl text-red-500 mb-4">✗</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Something went wrong</h2>
                <p class="text-gray-600 mb-6">${error.message || 'An error occurred while saving your assessment.'}</p>
                <div class="flex flex-col sm:flex-row justify-center gap-3">
                    <button onclick="closeAssessment()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                        Close
                    </button>
                    <button onclick="completeAssessment()" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 transition">
                        Try Again
                    </button>
                </div>
            </div>
        `;
    }
}

function showAssessmentResults(score, maxScore, insights) {
    const assessmentType = currentAssessment.type;
    const assessmentTypeDisplay = assessmentType === 'anxiety' ? 'GAD-7' : 'PHQ-9';
    const scoreText = `${score} out of ${maxScore}`;

    // Get severity info based on score and assessment type
    let severity, severityClass;

    if (assessmentType === 'anxiety') {
        if (score >= 15) {
            severity = 'Severe Anxiety';
            severityClass = 'bg-red-100 text-red-800';
        } else if (score >= 10) {
            severity = 'Moderate Anxiety';
            severityClass = 'bg-orange-100 text-orange-800';
        } else if (score >= 5) {
            severity = 'Mild Anxiety';
            severityClass = 'bg-yellow-100 text-yellow-800';
        } else {
            severity = 'Minimal or None';
            severityClass = 'bg-green-100 text-green-800';
        }
    } else if (assessmentType === 'depression') {
        if (score >= 20) {
            severity = 'Severe Depression';
            severityClass = 'bg-red-100 text-red-800';
        } else if (score >= 15) {
            severity = 'Moderately Severe Depression';
            severityClass = 'bg-orange-100 text-orange-800';
        } else if (score >= 10) {
            severity = 'Moderate Depression';
            severityClass = 'bg-yellow-100 text-yellow-800';
        } else if (score >= 5) {
            severity = 'Mild Depression';
            severityClass = 'bg-blue-100 text-blue-800';
        } else {
            severity = 'Minimal or None';
            severityClass = 'bg-green-100 text-green-800';
        }
    }

    // Update the UI with the AI insights
    const aiInsightsSection = document.getElementById('aiInsightsContent');
    const aiLoadingSection = document.getElementById('aiInsightsLoading');
    const aiComingSoonSection = document.getElementById('aiInsightsComingSoon');

    if (insights) {
        const summaryEl = document.getElementById('aiSummary');
        const recommendationsEl = document.getElementById('aiRecommendations');
        const resourcesEl = document.getElementById('aiResources');

        if (summaryEl) {
            summaryEl.textContent = insights.summary || 'No summary available.';
        }

        if (recommendationsEl && insights.recommendations) {
            recommendationsEl.innerHTML = insights.recommendations
                .map(rec => '<li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i><span>' + rec + '</span></li>')
                .join('');
        }

        if (resourcesEl && insights.resources) {
            resourcesEl.innerHTML = insights.resources
                .map(res => '<li class="flex items-start"><i class="fas fa-external-link-alt text-blue-500 mt-1 mr-2"></i><span>' + res + '</span></li>')
                .join('');
        }

        // Show the AI insights section
        if (aiInsightsSection) aiInsightsSection.classList.remove('hidden');
        if (aiLoadingSection) aiLoadingSection.classList.add('hidden');
    } else {
        // If no insights, show a message
        if (aiComingSoonSection) {
            aiComingSoonSection.classList.remove('hidden');
            aiComingSoonSection.innerHTML = '<p class="text-sm text-gray-600">AI insights are being generated. Please refresh the page in a moment to see your personalized insights.</p>';
        }
        if (aiLoadingSection) aiLoadingSection.classList.add('hidden');
    }

    // Show the results in the assessment page
    var resultsElement = document.getElementById('assessmentResults');
    if (resultsElement) {
        resultsElement.scrollIntoView({
            behavior: 'smooth'
        });
    }

    // Hide navigation buttons
    const navButtons = document.querySelector('.flex.justify-between.mt-6');
    if (navButtons) {
        navButtons.style.display = 'none';
    // Close the modal but DO NOT reload the page; keep insights visible
    document.getElementById('assessmentModal').classList.add('hidden')
}

function closeAssessment() {
    const modal = document.getElementById('assessmentModal');
    if (modal) {
        // Use centralized ModalUtils for layout shift prevention
        waitForModalUtils(() => {
            window.ModalUtils.close(ASSESSMENT_MODAL_ID, modal);
        });
    }
    
    // Reset state
    currentAssessment = null;
    currentQuestion = 0;
    assessmentAnswers = [];
}

function selectMood(mood) {
    // Remove selected class from all mood options
    document.querySelectorAll('.mood-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selected class to clicked option
    const selectedOption = document.querySelector(`.mood-option[data-mood="${mood}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
        selectedMood = selectedOption;  // Store the selected element
        
        // Show notes container
        const notesContainer = document.getElementById('mood-notes-container');
        if (notesContainer) {
            notesContainer.classList.remove('hidden');
        }
        
        // Enable save button
        const saveButton = document.getElementById('save-mood-btn');
        if (saveButton) {
            saveButton.disabled = false;
        }
    }
}

async function saveDailyMood() {
    if (!selectedMood) {
        showNotification('Please select a mood before saving.', 'error');
        return;
    }

    const mood = parseInt(selectedMood.getAttribute('data-mood'));
    const notes = document.getElementById('mood-notes').value;
    const saveButton = document.getElementById('save-mood-btn');
    
    // Disable button and show loading state
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

    try {
        const response = await fetch('/api/save-mood', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',  // For CSRF protection
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                mood: mood,
                notes: notes
            })
        });

        const data = await response.json();
        
        if (response.ok) {
            showNotification('Mood saved successfully!', 'success');
            
            // Reset form WITHOUT triggering chart re-renders
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById('mood-notes').value = '';
            
            // Close the mood modal if it's open
            const moodModal = document.getElementById('moodModal');
            if (moodModal) {
                moodModal.classList.add('hidden');
            }
            
            // Update points and streak display if they exist (without page refresh)
            if (data.points !== undefined) {
                const pointsElement = document.getElementById('user-points');
                if (pointsElement) {
                    pointsElement.textContent = data.points;
                }
            }
            
            if (data.streak !== undefined) {
                const streakElement = document.getElementById('user-streak');
                if (streakElement) {
                    streakElement.textContent = `${data.streak} day${data.streak !== 1 ? 's' : ''}`;
                }
            }
            
            // Update the history table and chart
            const newMoodAssessment = {
                id: 'mood-' + new Date().getTime(), // Create a temporary unique ID
                assessment_type: 'Daily Mood',
                score: mood,
                created_at: new Date().toISOString(),
                ai_insights: {} // No AI insights for mood
            };
            updateAssessmentHistory(newMoodAssessment);

            // No longer reloading the page
            // setTimeout(() => {
            //     window.location.reload();
            // }, 1000);
        } else {
            throw new Error(data.message || 'Failed to save mood');
        }
    } catch (error) {
        console.error('Error saving mood:', error);
        showNotification(error.message || 'An error occurred while saving your mood', 'error');
    } finally {
        // Re-enable button
        saveButton.disabled = false;
        saveButton.textContent = 'Save Mood';
    }
}

function scheduleFollowUp() {
    window.location.href = "{{ url_for('schedule') }}";
}

function viewProgress() {
    window.location.href = "{{ url_for('patient.progress') }}";
}

function showNotification(message, type) {
    // This function assumes a notification system is available, e.g., a flash message div in base.html
    // For a quick client-side notification, you might use a simple alert or a custom div that appears/disappears.
    // For now, we'll just log to console and use a simple alert if no flash system is visible.
    console.log(`Notification (${type}): ${message}`);
    // If you have a dedicated notification area, update it here.
    // Example: document.getElementById('notification-area').innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    alert(message); // Fallback for immediate feedback
}

// Initialize assessment history chart
function initializeAssessmentHistoryChart() {
    const ctx = document.getElementById('assessment-history-chart').getContext('2d');
    const assessmentData = JSON.parse(document.getElementById('assessment-data').dataset.assessments || '[]');

    // Destroy the old chart instance if it exists
    if (assessmentHistoryChart) {
        assessmentHistoryChart.destroy();
    }

    if (!assessmentData || assessmentData.length === 0) {
        // Placeholder for no data
        return;
    }

    const labels = assessmentData.map(a => new Date(a.created_at).toLocaleDateString()).reverse();
    const gad7Scores = assessmentData.map(a => a.assessment_type === 'GAD-7' ? a.score : null).reverse();
    const phq9Scores = assessmentData.map(a => a.assessment_type === 'PHQ-9' ? a.score : null).reverse();

    assessmentHistoryChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'GAD-7 Score',
                data: gad7Scores,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: false,
                spanGaps: true,
            }, {
                label: 'PHQ-9 Score',
                data: phq9Scores,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: false,
                spanGaps: true,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 27
                }
            }
        }
    });
}

// Get feedback based on assessment type and score
function getAssessmentFeedback(assessmentType, score, maxScore) {
    if (assessmentType === 'anxiety') {
        if (score >= 15) {
            return 'Your score suggests severe anxiety. We strongly recommend speaking with a mental health professional as soon as possible. Consider reaching out to your healthcare provider or a therapist for support.';
        } else if (score >= 10) {
            return 'Your score suggests moderate anxiety. You might benefit from speaking with a mental health professional to discuss your symptoms and explore treatment options.';
        } else if (score >= 5) {
            return 'Your score suggests mild anxiety. While your symptoms are not severe, you might find it helpful to practice stress-reduction techniques or speak with a healthcare provider if symptoms persist.';
        } else {
            return 'Your score suggests minimal to no anxiety. Continue practicing good mental health habits to maintain your well-being.';
        }
    } else if (assessmentType === 'depression') {
        if (score >= 20) {
            return 'Your score suggests severe depression. We strongly encourage you to seek help from a mental health professional as soon as possible. You are not alone, and support is available.';
        } else if (score >= 15) {
            return 'Your score suggests moderately severe depression. It would be beneficial to consult with a mental health professional to discuss your symptoms and treatment options.';
        } else if (score >= 10) {
            return 'Your score suggests moderate depression. Consider speaking with a healthcare provider about how you\'ve been feeling. Early intervention can be very helpful.';
        } else if (score >= 5) {
            return 'Your score suggests mild depression. While your symptoms are not severe, it may be helpful to monitor your mood and consider reaching out for support if symptoms persist or worsen.';
        } else {
            return 'Your score suggests minimal to no depression. Continue to engage in activities that support your mental well-being.';
        }
    } else if (assessmentType === 'mood') {
        const percentage = (score / maxScore) * 100;
        if (percentage >= 80) {
            return 'You\'re feeling great! Keep up whatever is working for you. Consider sharing your positive energy with others.';
        } else if (percentage >= 60) {
            return 'You\'re in a good place. Continue with your current routine and consider trying new activities that bring you joy.';
        } else if (percentage >= 40) {
            return 'You might be feeling a bit down today. Consider reaching out to a friend or engaging in an activity you enjoy.';
        } else if (percentage >= 20) {
            return 'You seem to be having a tough time. Consider talking to someone you trust about how you\'re feeling.';
        } else {
            return 'We\'re sorry to hear you\'re feeling this way. Please know that support is available, and you don\'t have to go through this alone.';
        }
    }
    return 'Thank you for completing the assessment. Your responses have been recorded.';
}

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeAssessmentHistoryChart();
});

function updateAssessmentHistory(newAssessment) {
    // Add to data
    assessmentData.unshift(newAssessment);

    // Update table
    const tableBody = document.getElementById('assessmentHistory');
    const newRow = document.createElement('tr');

    const severityInfo = get_severity_info(newAssessment.assessment_type, newAssessment.score);

    newRow.innerHTML = `
        <td class="px-4 py-3 text-sm text-gray-700">${new Date(newAssessment.created_at).toLocaleString()}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${newAssessment.assessment_type}</td>
        <td class="px-4 py-3 text-sm font-semibold text-blue-600">${newAssessment.score}</td>
        <td class="px-4 py-3 text-sm">
            <span class="px-2 py-1 rounded-full text-xs font-medium bg-${severityInfo.color}-100 text-${severityInfo.color}-800">${severityInfo.severity}</span>
        </td>
        <td class="px-4 py-3 text-sm">
            <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="viewAssessmentDetails('${newAssessment.id}')">
                <i class="fas fa-eye"></i> View
            </button>
        </td>
    `;

    // Remove "No assessments" row if it exists
    const noAssessmentsRow = tableBody.querySelector('td[colspan="5"]');
    if (noAssessmentsRow) {
        noAssessmentsRow.parentElement.remove();
    }

    tableBody.prepend(newRow);

    // Update chart
    initializeAssessmentHistoryChart();
}

// Helper function to get severity info, adapted from the backend
function get_severity_info(assessment_type, score) {
    if (score === null || score === undefined) {
        return { 'severity': 'N/A', 'color': 'gray' };
    }
    score = parseFloat(score);
    if (assessment_type === 'GAD-7') {
        if (score <= 4) return { 'severity': 'Minimal', 'color': 'green' };
        if (score <= 9) return { 'severity': 'Mild', 'color': 'yellow' };
        if (score <= 14) return { 'severity': 'Moderate', 'color': 'orange' };
        return { 'severity': 'Severe', 'color': 'red' };
    } else if (assessment_type === 'PHQ-9') {
        if (score <= 4) return { 'severity': 'Minimal', 'color': 'green' };
        if (score <= 9) return { 'severity': 'Mild', 'color': 'yellow' };
        if (score <= 14) return { 'severity': 'Moderate', 'color': 'orange' };
        return { 'severity': 'Severe', 'color': 'red' };
    } else if (assessment_type === 'Daily Mood') {
        if (score >= 4) return { 'severity': 'Positive', 'color': 'green' };
        if (score >= 3) return { 'severity': 'Neutral', 'color': 'yellow' };
        return { 'severity': 'Negative', 'color': 'red' };
    }
    return { 'severity': 'N/A', 'color': 'gray' };
}

// Function to view assessment details (placeholder for now)
function viewAssessmentDetails(assessmentId) {
    alert(`Viewing details for assessment ID: ${assessmentId}`);
    // In a real app, you'd fetch details via AJAX and display in a modal
}

</script>
{% endblock %}

